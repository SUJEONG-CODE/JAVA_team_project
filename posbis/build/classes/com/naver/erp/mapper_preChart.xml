<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm-->
<!-- mapper 태그 선언 -->
<!--mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm-->
	<!-- namespace 속성값으로 [DAO 인터페이스명]이 오며 -->
	<!-- [DAO 인터페이스] 메소드명과 동일한 id 값을 소유한 태그를 내포하고 있다. -->
<!--mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm-->
<mapper namespace="com.naver.erp.PreChartDAO">


<!-- ============== u_no 얻기 =========================================================================== -->

	<select id='getUserNo' parameterType="String" resultType="int">	
		select u_no from user_info where user_id=#{user_id}
	</select>
	
<!-- ============== business_no 얻기 =========================================================================== -->
	
	<select id='getBusinessNoList' parameterType="int" resultType="java.util.HashMap">	
		select 
			business_no as "business_no" 
			, business_name as "business_name"
			
		from business_info 
			where 
				1=1 
				and u_no=#{u_no}
			
	</select>

<!-- 	<select id='getBusinessNoList' parameterType="int" resultType="String">	
		select business_no as "business_no" from business_info 
			where 
				1=1 
				and u_no=#{u_no}
			
	</select> -->
	
<!-- ============== 나의 가게 월 매출 구하기 =========================================================================== -->
	
	<select id='getSalesMonthList' parameterType="String" resultType="java.util.HashMap">	
		    select
			    nvl(to_char(sum(m.menu_price * s.sales_count)),'0') as "sales_amount"
			    , mon.month as "판매월"
			    from
			    (
			        select '01' "MONTH" from dual
			        union select '02' from dual
			        union select '03' from dual
			        union select '04' from dual
			        union select '05' from dual
			        union select '06' from dual
			        union select '07' from dual
			        union select '08' from dual
			        union select '09' from dual
			        union select '10' from dual
			        union select '11' from dual
			        union select '12' from dual
			    ) mon
			     left outer join sales s on mon.month=extract(month from s.sales_date)
			     left outer join  business_info b on b.business_no=s.business_no
			     left outer join menu m on s.menu_no=m.menu_no
			     and b.business_no = #{changeBusinessNo}
			    group by mon.month
			    order by mon.month

			
	</select>
	
	
<!-- ============== 같은 업종, 같은 동네 가게들 월평균 구하기 =========================================================================== -->
	
	<select id='getAllSalesMonthList' parameterType="String" resultType="java.util.HashMap">	
		     select

			    nvl(to_char(sum(m.menu_price * s.sales_count)/
			    (select count(*) from business_info b
			    where b.business_no != #{changeBusinessNo}
			    and ( b.addr_no = (select addr_no from business_info where business_no=#{changeBusinessNo}) )
			    and ( b.business_type_code = (select business_type_code from business_info where business_no=#{changeBusinessNo}) )
			    )),'0') as "sales_amount"
			    
			    , mon.month as "판매월"
			    
			    from
			    (
			        select '01' "MONTH" from dual
			        union select '02' from dual
			        union select '03' from dual
			        union select '04' from dual
			        union select '05' from dual
			        union select '06' from dual
			        union select '07' from dual
			        union select '08' from dual
			        union select '09' from dual
			        union select '10' from dual
			        union select '11' from dual
			        union select '12' from dual
			    ) mon
			     left outer join sales s on mon.month=extract(month from s.sales_date)
			     left outer join  business_info b on b.business_no=s.business_no
			     left outer join menu m on s.menu_no=m.menu_no
			     and b.business_no != #{changeBusinessNo}
			     and ( b.addr_no = (select addr_no from business_info where business_no=#{changeBusinessNo}) )
			     and ( b.business_type_code = (select business_type_code from business_info where business_no=#{changeBusinessNo}) )
			    group by mon.month
			    order by mon.month
			
	</select>

	
<!-- ============== 나의 가게 인기메뉴 구하기 =========================================================================== -->
<!-- rank로 순서를 정하고 sua(s.sales_count)를 문자형으로 고쳐서 List<Map<String,String>> 형태를 맞춰줌. -->
 	
	<select id='getMyPopularityMenu' parameterType="String" resultType="java.util.HashMap">	
		     select menu_name, sales_count from(
			    select
			        s.menu_no "menu_no"
			        , (select m.menu_name from menu m where s.menu_no = m.menu_no) "MENU_NAME"
			        , sum(s.sales_count)||'' "SALES_COUNT"
			        ,rank() over (order by sum(s.sales_count) desc) "RN"
			    from sales s
			      where s.business_no=#{changeBusinessNo}
			      group by s.menu_no
			      )
			where rn=1

	</select>
	
	
<!-- ============== 다른 가게 인기메뉴 구하기 =========================================================================== -->
	
	<select id='getOthersPopularityMenu' parameterType="String" resultType="java.util.HashMap">	
		     select menu_name, sales_count from(
			    select
			        s.menu_no "menu_no"
			        , (select m.menu_name from menu m where s.menu_no = m.menu_no) "MENU_NAME"
			        , sum(s.sales_count)||'' "SALES_COUNT"
			        ,rank() over (order by sum(s.sales_count) desc) "RN"
			    from sales s , business_info b
			      where s.business_no = b.business_no
			        and b.business_no != #{changeBusinessNo}
			        and ( b.addr_no = (select addr_no from business_info where business_no=#{changeBusinessNo}) )
			        and ( b.business_type_code = (select business_type_code from business_info where business_no=#{changeBusinessNo}) )
			      group by s.menu_no
			      order by 3 desc)
			where rn=1 

	</select>

		
		
	
</mapper>
	